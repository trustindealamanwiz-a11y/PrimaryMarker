<!DOCTYPE html>
<html>
<head>
  <title>Secure Data Form</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>Login to Access Form</h2>

  <!-- Google Sign-In Button -->
  <div id="g_id_onload"
       data-client_id="599836800018-6df1f03d2l70q5aoncd0s3b99j72je38.apps.googleusercontent.com"
       data-callback="handleCredentialResponse">
  </div>
  <div class="g_id_signin" data-type="standard"></div>

  <!-- Data Form -->
  <form id="dataForm" style="display:none; margin-top:20px;">
    <label>Email:</label><br>
    <input type="email" name="email" readonly><br><br>

    <label>Location:</label><br>
    <button type="button" onclick="getLocation()">Get Location</button><br>
    <input type="text" name="latitude" placeholder="Latitude" readonly required>
    <input type="text" name="longitude" placeholder="Longitude" readonly required><br><br>

    <label>Photo 1:</label>
    <input type="file" name="photo1" accept="image/*" required><br><br>

    <label>Photo 2:</label>
    <input type="file" name="photo2" accept="image/*" required><br><br>

    <label>Choice:</label>
    <select name="choice">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select><br><br>

    <label>Remark:</label><br>
    <textarea name="remark"></textarea><br><br>

    <button type="submit">Submit</button>
  </form>

  <script>
    const allowedEmails = ["trustindeal.amanwiz@gmail.com", "xyz@gmail.com"]; // <-- yahan allowed emails likho
    const scriptURL = "https://script.google.com/macros/s/AKfycbyb0CI0mL5nkHmLjYm_AYwgZyhcmefGGJ85NAvsLrbQGLa-oaoy0no_q0A9Ky-PIqh6kw/exec"; // <-- yahan backend ka URL dalna

    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      const email = data.email;

      if (allowedEmails.includes(email)) {
        document.querySelector('[name="email"]').value = email;
        document.getElementById("dataForm").style.display = "block";
      } else {
        alert("Access denied for " + email);
      }
    }

    function parseJwt (token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          document.querySelector('[name="latitude"]').value = position.coords.latitude;
          document.querySelector('[name="longitude"]').value = position.coords.longitude;
        });
      } else {
        alert("Geolocation not supported.");
      }
    }

    function compressImage(file, maxSizeKB, callback) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const scaleFactor = Math.sqrt((maxSizeKB * 1024) / file.size);
          canvas.width = img.width * scaleFactor;
          canvas.height = img.height * scaleFactor;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(function(blob) {
            callback(blob);
          }, 'image/jpeg', 0.8);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    document.getElementById("dataForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const photos = [];

      const processPhoto = (file, index, callback) => {
        compressImage(file, 200, function(blob) {
          const reader = new FileReader();
          reader.onloadend = function() {
            const base64 = reader.result.split(',')[1];
            photos[index] = {
              name: file.name,
              ext: file.name.split('.').pop(),
              type: file.type,
              data: base64
            };
            callback();
          };
          reader.readAsDataURL(blob);
        });
      };

      processPhoto(formData.get("photo1"), 0, () => {
        processPhoto(formData.get("photo2"), 1, () => {
          const data = {
            email: formData.get("email"),
            latitude: formData.get("latitude"),
            longitude: formData.get("longitude"),
            choice: formData.get("choice"),
            remark: formData.get("remark"),
            photos: photos
          };

          fetch(scriptURL, {
            method: "POST",
            body: JSON.stringify(data)
          })
          .then(res => res.json())
          .then(res => {
            if (res.status === "success") {
              alert("Data submitted successfully!");
              e.target.reset();
              document.getElementById("dataForm").style.display = "none";
            } else {
              alert("Error: " + res.message);
            }
          })
          .catch(err => alert("Error: " + err));
        });
      });
    });
  </script>
</body>
</html>
