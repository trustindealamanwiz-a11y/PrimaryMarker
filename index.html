<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tag Splitter</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .hidden { display: none; }
  form { max-width: 500px; margin: auto; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input, select, textarea, button { width: 100%; padding: 8px; margin-top: 5px; }
  button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
  button:hover { background-color: #45a049; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<h2>Tag Splitter</h2>
<div id="signin-section">
  <div id="g_id_onload"
    data-client_id="YOUR_GOOGLE_CLIENT_ID"
    data-callback="handleCredentialResponse">
  </div>
  <div class="g_id_signin" data-type="standard"></div>
  <p>Only allowed emails can access the form.<br>Please contact Admin if your ID is not registered!</p>
</div>

<div id="form-section" class="hidden">
  <h3>Primary line marking</h3>
  <form id="dataForm">
    <input type="hidden" id="email" name="email">

    <div id="locationInputContainer" class="hidden">
      <label for="locationLink">Location Link</label>
      <input type="url" id="locationLink" name="locationLink" placeholder="Enter Google Maps link" required>
    </div>

    <label>JC Photo (Required)</label>
    <input type="file" id="photo1" accept="image/*" capture="environment" required>

    <label>Area Photo (Required)</label>
    <input type="file" id="photo2" accept="image/*" capture="environment" required>

    <label>JC Name</label>
    <input type="text" id="jcName" name="jcName" required>

    <label>Select Splitter</label>
    <select id="splitter" name="splitter" required>
      <option value="">-- Select --</option>
      <option>2 way</option>
      <option>4 way</option>
      <option>8 way</option>
      <option>16 way</option>
    </select>

    <label>Select Wire</label>
    <select id="wire" name="wire" required>
      <option value="">-- Select --</option>
      <option>1 Core</option>
      <option>2 Core</option>
      <option>4 Core</option>
      <option>6 Core</option>
      <option>12 Core</option>
      <option>24 Core</option>
      <option>48 Core</option>
      <option>96 Core</option>
    </select>

    <label>Wire Color</label>
    <select id="wireColor" name="wireColor" required>
      <option value="">-- Select --</option>
      <option>Black</option>
      <option>Orange</option>
      <option>Other</option>
    </select>

    <label>Line Name (Optional)</label>
    <input type="text" id="lineName" name="lineName">

    <label>Drum No (Optional)</label>
    <input type="text" id="drumNo" name="drumNo">

    <label>Remarks</label>
    <textarea id="remark" name="remark"></textarea>

    <button type="submit">Submit</button>
  </form>
</div>

<script>
const ALLOWED_EMAILS = ["trustindeal.amanwiz@gmail.com"]; // Allowed email list
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzb4tivDfLHvTTgTKDhPZRQyNnn5ZouPURgQmPkzUO-8awT_e3FMnG_ishuCPZrYj7Tcw/exec";

function handleCredentialResponse(response) {
  const data = parseJwt(response.credential);
  if (ALLOWED_EMAILS.includes(data.email)) {
    document.getElementById("signin-section").classList.add("hidden");
    document.getElementById("form-section").classList.remove("hidden");
    document.getElementById("email").value = data.email;
    detectLocation();
  } else {
    alert("Access denied. Please contact Admin.");
  }
}

function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
  ).join(''));
  return JSON.parse(jsonPayload);
}

function detectLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      document.getElementById("locationLink").value =
        `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
    }, err => {
      document.getElementById("locationInputContainer").classList.remove("hidden");
    });
  } else {
    document.getElementById("locationInputContainer").classList.remove("hidden");
  }
}

document.getElementById("dataForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  try {
    const formData = {
      email: document.getElementById("email").value,
      locationLink: document.getElementById("locationLink").value,
      photo1: await toBase64(document.getElementById("photo1").files[0]),
      photo2: await toBase64(document.getElementById("photo2").files[0]),
      jcName: document.getElementById("jcName").value,
      splitter: document.getElementById("splitter").value,
      wire: document.getElementById("wire").value,
      wireColor: document.getElementById("wireColor").value,
      lineName: document.getElementById("lineName").value,
      drumNo: document.getElementById("drumNo").value,
      remark: document.getElementById("remark").value
    };

    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(formData),
      headers: { "Content-Type": "application/json" }
    });

    const result = await res.json();
    if (result.status === "success") {
      alert("Data submitted successfully!");
      document.getElementById("dataForm").reset();
    } else {
      alert("Error: " + result.message);
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
});

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}
</script>

</body>
</html>
