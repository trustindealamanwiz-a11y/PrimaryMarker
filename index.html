<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Tagging splitters</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link rel="stylesheet" href="style.css">
<style>
/* File input custom style with camera icon */
input[type="file"] {
  display: block;
  padding: 8px;
  border: 2px dashed #aaa;
  border-radius: 8px;
  background: #f9f9f9 url('https://cdn-icons-png.flaticon.com/512/685/685655.png') no-repeat 10px center;
  background-size: 20px 20px;
  padding-left: 40px;
  cursor: pointer;
  transition: 0.3s ease;
}
input[type="file"]:hover {
  border-color: #007bff;
  background-color: #eef6ff;
}
input[type="file"]::-webkit-file-upload-button {
  visibility: hidden;
}
input[type="file"]::before {
  content: "📷 Choose Photo";
  display: inline-block;
  background: #007bff;
  color: white;
  padding: 6px 12px;
  border-radius: 5px;
  font-size: 14px;
  margin-right: 10px;
  cursor: pointer;
}
input[type="file"]:hover::before {
  background: #0056b3;
}

/* Relogin button */
#reloginBtn {
  margin-top: 10px;
  padding: 6px 12px;
  background: #dc3545;
  color: #fff;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  display: none;
}
#reloginBtn:hover {
  background: #a71d2a;
}

/* Toast */
.toast {
  visibility: hidden;
  min-width: 200px;
  margin-left: -100px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 10px;
  position: fixed;
  z-index: 1;
  left: 50%;
  bottom: 30px;
  font-size: 14px;
}
.toast.show {
  visibility: visible;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}
@keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
@keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
</style>
</head>
<body>
<header>
<h2 class="page-title">Tag Splitter</h2>
</header>

<!-- Sign-in card -->
<div id="signinCard" class="card">
  <div class="row center">
    <div id="signinBtn"></div>
  </div>
  <div id="accessMsg" class="row muted small-text">
    Please contact Admin if your ID is not registered!
  </div>
  <div id="deniedMsg" class="row error hidden">
    Access denied — Contact admin for register your mail id with virtual backoffice !
  </div>
  <div class="row center">
    <button id="reloginBtn">🔄 Re-login</button>
  </div>
</div>

<!-- Form card -->
<div id="formCard" class="card hidden">
  <div class="row muted" id="whoami"></div>
  <form id="dataForm" class="form">
    <input type="email" name="email" class="hidden" readonly required />
    <input type="hidden" name="startTime" />

    <div class="form-step">Step 1 - Splitter image input</div>
    <div class="row">
      <label>Upload Splitter Photo:</label>
      <input type="file" name="photo" accept="image/*" capture="environment" required />
    </div>

    <div class="form-step">Step 2 - Splitter code input</div>
    <div class="row">
      <label>Splitter Code:</label>
      <input type="text" name="splitterCode" placeholder="Enter Splitter Code" required />
    </div>

    <div class="form-step">Step 3 - Location input</div>
    <div class="row hidden" id="locationRow">
      <label>Location Link:</label>
      <input type="url" name="locationLink" placeholder="Paste Google Maps Link" />
    </div>

    <div class="form-step">Step 4 - Remarks input</div>
    <div class="row">
      <label>Remarks:</label>
      <textarea name="remarks" placeholder="Enter remarks if any"></textarea>
    </div>

    <div class="form-step">Step 5 - Address input</div>
    <div class="row">
      <label>Address:</label>
      <textarea name="address" placeholder="Enter Address" required></textarea>
    </div>

    <div class="form-step">Step 6 - Splice Splitter input</div>
    <div class="row">
      <label>Splice Splitter:</label>
      <input type="text" name="splice" placeholder="Enter Splice Splitter" required />
    </div>

    <div class="form-step">Step 7 - Submit</div>
    <div class="row actions">
      <button type="submit" id="submitBtn" class="btn success" disabled>
        Tagging done <span id="countdown"></span>
      </button>
      <br>
      <span id="submitStatus" class="muted small-text"></span>
    </div>
  </form>
</div>

<div id="toast" class="toast"></div>

<script>
const allowedEmails = [
  "rajsingh8112812272@gmail.com",
  "trustindeal.amanwiz@gmail.com",
  "mrityunjaykumar7602@gmail.com",
  "4278146@gmail.com",
  "manojbaba231352@gmail.com"
];
const scriptURL = "https://script.google.com/macros/s/AKfycbyb0CI0mL5nkHmLjYm_AYwgZyhcmefGGJ85NAvsLrbQGLa-oaoy0no_q0A9Ky-PIqh6kw/exec";
const clientID = "599836800018-6df1f03d2l70q5aoncd0s3b99j72je38.apps.googleusercontent.com";

window.onload = () => {
  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.initialize({
      client_id: clientID,
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.getElementById("signinBtn"),
      { theme: "outline", size: "large", type: "standard", shape: "pill" }
    );
  }

  // Session check
  const savedToken = localStorage.getItem("id_token");
  const savedTime = localStorage.getItem("login_time");
  if (savedToken && savedTime && Date.now() - parseInt(savedTime) < 3600 * 1000) {
    handleCredentialResponse({ credential: savedToken }, true);
  }

  document.getElementById("dataForm").addEventListener("submit", onSubmit);

  document.getElementById("reloginBtn").addEventListener("click", () => {
    localStorage.removeItem("id_token");
    localStorage.removeItem("login_time");
    location.reload();
  });

  autoDetectLocation();
};

function parseJwt(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
    return JSON.parse(jsonPayload);
  } catch {
    return {};
  }
}

function handleCredentialResponse(response, isSession = false) {
  const payload = parseJwt(response.credential);
  const email = payload.email || "";

  if (allowedEmails.includes(email)) {
    document.querySelector('[name="email"]').value = email;
    document.getElementById("whoami").innerHTML = `Welcome, ${email}`;
    document.getElementById("deniedMsg").classList.add("hidden");
    document.getElementById("signinCard").classList.add("hidden");
    document.getElementById("formCard").classList.remove("hidden");

    if (!isSession) {
      localStorage.setItem("id_token", response.credential);
      localStorage.setItem("login_time", Date.now().toString());
    }
  } else {
    document.getElementById("deniedMsg").classList.remove("hidden");
    document.getElementById("reloginBtn").style.display = "inline-block";
  }
}

function autoDetectLocation() {
  if (!navigator.geolocation) {
    document.getElementById("locationRow")?.classList.remove("hidden");
    document.querySelector("[name=locationLink]")?.setAttribute("required", "true");
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const locInput = document.querySelector("[name=locationLink]");
      if (locInput) locInput.value = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    },
    () => document.getElementById("locationRow")?.classList.remove("hidden"),
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

async function compressImageToDataURL(file, maxWidth = 1024, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const scaleSize = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scaleSize;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL("image/jpeg", quality));
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function onSubmit(e) {
  e.preventDefault();
  const form = e.target;
  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  document.getElementById("submitStatus").innerText = "Uploading...";

  const formData = new FormData(form);
  formData.set("startTime", new Date().toISOString());

  const photoFile = form.photo.files[0];
  if (photoFile) {
    try {
      const compressedDataUrl = await compressImageToDataURL(photoFile);
      formData.delete("photo");
      formData.append("photo", compressedDataUrl);
    } catch (err) {
      console.error("Image compression failed:", err);
    }
  }

  try {
    const resp = await fetch(scriptURL, { method: "POST", body: formData });
    if (resp.ok) {
      showToast("✔️ Data submitted successfully!");
      form.reset();
      document.querySelector('[name="email"]').value = localStorage.getItem("user_email") || "";
      startTagging();
    } else {
      showToast("❌ Submission failed!");
    }
  } catch (err) {
    console.error(err);
    showToast("⚠️ Error submitting form");
  }
  submitBtn.disabled = false;
  document.getElementById("submitStatus").innerText = "";
}

function showToast(msg) {
  const toast = document.getElementById("toast");
  toast.innerText = msg;
  toast.className = "toast show";
  setTimeout(() => { toast.className = "toast"; }, 3000);
}

function startTagging() {
  const btn = document.getElementById("submitBtn");
  const countdown = document.getElementById("countdown");
  let sec = 5;
  btn.disabled = true;
  countdown.innerText = `(${sec})`;

  const timer = setInterval(() => {
    sec--;
    countdown.innerText = sec > 0 ? `(${sec})` : "";
    if (sec <= 0) {
      clearInterval(timer);
      btn.disabled = false;
    }
  }, 1000);
}
</script>
</body>
</html>
