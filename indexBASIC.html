<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Data Submission Form</title>
</head>
<body>
  <h2>Submit Your Data</h2>
  <form id="dataForm">
    Email: <input type="email" name="email" required><br><br>
    <button type="button" onclick="getLocation()">Get Location</button><br>
    <input type="text" name="latitude" placeholder="Latitude" readonly required>
    <input type="text" name="longitude" placeholder="Longitude" readonly required><br><br>
    Photo 1: <input type="file" name="photo1" accept="image/*" required><br>
    Photo 2: <input type="file" name="photo2" accept="image/*"><br><br>
    Choice:
    <select name="choice" required>
      <option value="">--Select--</option>
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select><br><br>
    Remark:<br>
    <textarea name="remark"></textarea><br><br>
    <button type="submit">Submit</button>
  </form>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyb0CI0mL5nkHmLjYm_AYwgZyhcmefGGJ85NAvsLrbQGLa-oaoy0no_q0A9Ky-PIqh6kw/exec";

    function getLocation() {
      navigator.geolocation.getCurrentPosition(position => {
        document.querySelector("[name=latitude]").value = position.coords.latitude;
        document.querySelector("[name=longitude]").value = position.coords.longitude;
      }, () => alert("Failed to get location"));
    }

    function compressImage(file, maxSizeKB, callback) {
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.src = reader.result;
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const scale = Math.min(1, Math.sqrt((maxSizeKB * 1024) / file.size));
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          let quality = 0.7;
          let dataUrl = canvas.toDataURL("image/jpeg", quality);
          while (dataUrl.length / 1024 > maxSizeKB && quality > 0.1) {
            quality -= 0.05;
            dataUrl = canvas.toDataURL("image/jpeg", quality);
          }
          callback(dataUrl);
        };
      };
      reader.readAsDataURL(file);
    }

    document.getElementById("dataForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const form = e.target;
      const photos = [];

      await new Promise(res => compressImage(form.photo1.files[0], 200, dataUrl => { photos.push(dataUrl); res(); }));
      if (form.photo2.files[0]) {
        await new Promise(res => compressImage(form.photo2.files[0], 200, dataUrl => { photos.push(dataUrl); res(); }));
      }

      const data = {
        email: form.email.value,
        latitude: form.latitude.value,
        longitude: form.longitude.value,
        photos,
        choice: form.choice.value,
        remark: form.remark.value
      };

      fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(data),
        redirect: "follow"
      })
      .then(res => res.json())
      .then(resp => {
        if (resp.status === "success") {
          alert("Successfully submitted!");
          form.reset();
        } else {
          alert("Error: " + resp.message);
        }
      })
      .catch(err => alert("Network error: " + err));
    });
  </script>
</body>
</html>
